= GenTaR REST API
{date}
:doctype: book
:icons: font
:source-highlighter: highlightjs
:highlightjs-theme: github
:toc: left
:toclevels: 3
:sectlinks:
:sectnums:

[introduction]
== Introduction

GenTaR is designed to coordinate the production of transgenic mice between high-throughput
mouse production facilities and consortia of clinicians and human geneticists
while minimizing the overlap	and	maximizing	efficiencies. GenTaR captures the intention	of
a particular consortium	to produce mutant mice on a	particular	gene, the	progress	of
mouse	production	and	modified mutation creation on the	original mouse,	and	the	capture
of	phenotype	data	on	the	mouse.

This is a secure resource that can house various types of mutations linked to genes,
and will provide different data access policies to users.

This guide is aimed at developers of such applications.

== Usage of HTTP Verbs

The following table describes how the GenTaR API interprets the HTTP verbs.

.HTTP Verbs
|===
|HTTP Verb | Usage

|GET
|GET is used to retrieve information without changing the state of the system.

|POST
|POST is used to submit an entity to the specified resource, often causing a change in state or side effects on the system.

|PUT
|PUT method replaces all current representations of the target resource with the request payload.

|===



== Authentication
anchor:login[]

After a user registered, he or she can start working with GenTaR.
The first step is login. To log in in GenTaR use the /auth/signin endpoint. The user must use the username and the password
specified at registration. If the login was successful user gets a JSON Web Token (see https://jwt.io):

After that the user has to use the access token for authentication with each request to a protected route or resource.
The tokens are signed by the server so the server can validate the signature of the token to grant the access to resources.
The access token is a Base64 encoded String, that must be added to Authorization HTTP header like this:

 Authorization: Bearer eyJhbGciOiJSUzI1NiJIUzI1NiJ9.eyJpc3MiOiJjb2RlcmFkYXIiLCJleHAiOjE0ODQ1MTUzOTUsInR5cGUiOiJSRUZSRVNIIiwiaWF0IjoxNDg0NTE1NDU1LCJ1c2VySWQiOiIxIiwidXNlcm5hbWUiOiJyYWRhciJ9.zfkyc5jkPiAUEt7nU25SJxKprcPiXaiq0Q6bCJ_RrQo

The access token is short-lived and by default expires after 30 minutes.

A typical work flow looks like this:

. Client logs in with username and password and gets one token
. Client requires resources using the access token in each request
. After 30 minutes client gets a 401-Response
. Clients logs in again and gets a new token

See more: https://auth0.com/docs/tokens/refresh-token and https://auth0.com/blog/refresh-tokens-what-are-they-and-when-to-use-them/


=== POST
==== Successful authentication

===== Login Data Structure
include::{snippets}/auth/signin/request-fields.adoc[]

===== Example Request
include::{snippets}/auth/signin/http-request.adoc[]

===== Example Response
include::{snippets}/auth/signin/http-response.adoc[]

===== Response Structure
include::{snippets}/auth/signin/response-fields.adoc[]

==== Error in authentication: user/password is incorrect
When trying to sign in with an incorrect user/password the system will inform about it returning
an error message.

.request
include::{snippets}/auth/signin/no-valid-user-password/http-request.adoc[]

.response
include::{snippets}/auth/signin/no-valid-user-password/http-response.adoc[]


== Projects
anchor:chapter-configure[]
This section describes the REST endpoints for projects in the system.

A project in GenTaR is the container for the intention and has one or more plans with the attempt
information.

=== Fields
These are the fields you are going to see in the body of a request in a GET or in the payload for POST or PUT
operations.
include::{snippets}/projects/getProject/response-fields.adoc[]

=== Filters
When you use the endpoint to get all the projects, you can also use filters to reduce the results.
This is the list of filters you can use:

.Filters for projects
|===
|Filter name | Description

|tpn
|TPN(s) to be used as a filter. Eg: TPN:000000013.

|intention
a|Name of the intention. Possible values:

- Point Mutation
- Deletion
- Exon Deletion
- Intra-exon deletion
- Inter-exon deletion
- Whole-gene deletion
- Copy Number Variant
- SNP
- Insertion
- Inverted insertion
- Inversion
- Indel
- Complex rearrangement

|gene
|Marker symbol or accession id(s). Eg.Vps37a,MGI:1261835

|workUnitName
|Name of the work unit(s) associated with any of the plans in the project.

|workGroupName
|Name of the work group(s) associated with any of the plans in the project.

|assignmentStatusName
a|Assignment Status Name. Possible values:

* Assigned
* Inspect - Conflict
* Inactive
* Abandoned
* Inspect - Attempt
* Inspect - GLT Mouse

|summaryStatusName
|Summary Status of the project. Eg: Plan Created.

|privacyName
|The privacy of the project. Any of: public, protected, restricted.

|externalReference
|External reference for the project.

|imitsMiPlanId
|Ids in iMits (if the project was migrated from there).

|===

=== GET
==== Get a specific project

This endpoint shows a project in the system.

===== Example Request

Curl:
include::{snippets}/projects/getProject/curl-request.adoc[]

===== Example Response

include::{snippets}/projects/getProject/http-response.adoc[]


==== Get all Projects
This endpoint shows all the projects the user has permission to see.

===== Example Request

Curl:
include::{snippets}/projects/allProjects/curl-request.adoc[]

===== Example Response

include::{snippets}/projects/allProjects/http-response.adoc[]

==== Get all Projects using filters.

You can also apply filters to the endpoint to refine the search. This is a list of the filters you can
use. Each filter admits several values separated by comma.


===== Example Request

Curl:
include::{snippets}/projects/allProjectsWithFilter/http-request.adoc[]

===== Example Response

include::{snippets}/projects/allProjectsWithFilter/http-response.adoc[]

=== POST

==== Create a project

In order to create a project, it's necessary to create also a plan attached to it.

===== Example Request

Curl:
include::{snippets}/projects/postProject/http-request.adoc[]

===== Example Response

include::{snippets}/projects/postProject/http-response.adoc[]

===== Fields in Response
include::{snippets}/projects/postProject/response-fields.adoc[]

=== PUT

==== Update a project

You can update some information in a project if you are related with any of the
work units in the plans for the project.

===== Example Request

Curl:
include::{snippets}/projects/putProject/http-request.adoc[]

===== Example Response

include::{snippets}/projects/putProject/http-response.adoc[]

===== Fields in Response
include::{snippets}/projects/putProject/response-fields.adoc[]

== Plans
anchor:chapter-configure[]
This section describes the REST endpoints for plans in the system.

=== Fields
These are the fields you are going to see in the body of a request in a GET or in the payload for POST or PUT
operations.

==== Crispr plan.
include::{snippets}/plans/getCrisprPlan/response-fields.adoc[]

==== Phenotyping plan.
include::{snippets}/plans/getPhenotypingPlan/response-fields.adoc[]

=== Filters
When you use the endpoint to get all the plans, you can also use filters to reduce the results.
This is the list of filters you can use:

==== Common filters

.Common filters for plans
|===
|Filter name | Description

|pin
|PIN(s) to be used as a filter. Eg: PIN:0000000014.

|tpn
|TPN(s) to be used as a filter. Eg: TPN:000000001.

|workUnitName
|Name of the work unit associated with the plan.

|workGroup
|Name of the work group associated with the plan.

|summaryStatusName
|Name of the summary status in the plan.

|typeName a|Name of the type of the plan. Possible values are:

* production
* phenotyping

|===

==== Specific filters for production plan

.Filters for production plans
|===
|attemptTypeName a|Attempt type. Possible values are:

* crispr
* haplo-essential crispr
* haplo-essential crispr
* breeding

|imitsMiAttemptIds
|iMits mi attempt id.

|===

==== Specific filters for phenotyping plan

.Filters for phenotyping plans
|===
|attemptTypeName a|Attempt type. Possible values are:

* adult phenotyping
* haplo-essential phenotyping

|imitsPhenotypeAttemptIds
|iMits phenotyping attempt id.

|phenotypingExternalRef
|Phentoyping External Reference (colony name or specimen group name)

|===

=== GET
==== Get a specific plan

This endpoint shows a plan in the system.

===== Example Request

Curl:
include::{snippets}/plans/getCrisprPlan/curl-request.adoc[]

===== Example Response

include::{snippets}/plans/getCrisprPlan/http-response.adoc[]

==== Get all Plans
This endpoint shows all the plans the user has permission to see.

===== Example Request

Curl:
include::{snippets}/plans/allPlans/curl-request.adoc[]

===== Example Response

include::{snippets}/plans/allPlans/http-response.adoc[]

==== Get filtered Plans
You can also add filters to the request to get more specific results.

===== Example Request

Curl:
include::{snippets}/plans/filteredPlans/curl-request.adoc[]

===== Example Response

include::{snippets}/plans/filteredPlans/http-response.adoc[]

==== Get the history of changes for a plan

You can use this endpoint to see all the changes that have been made on a plan.

===== Example Request

Curl:
include::{snippets}/plans/history/curl-request.adoc[]

===== Example Response

include::{snippets}/plans/history/http-response.adoc[]

=== POST

==== Create a crispr plan

===== Example Request

Curl:
include::{snippets}/plans/postCrisprPlan/http-request.adoc[]

===== Example Response

include::{snippets}/plans/postCrisprPlan/http-response.adoc[]

==== Create a phenotyping plan

===== Example Request

Curl:
include::{snippets}/plans/postPhenotypingPlan/http-request.adoc[]

===== Example Response
include::{snippets}/plans/postPhenotypingPlan/http-response.adoc[]


=== PUT

You can update some information in a plan if you are related with any of the
work units for that plan.

The only fields that can be modified are the ones shown in "Example Request". The exception are
pin and tpn, which are there just as a reference to the object that is being modified (they are not
mandatory).

If a value is provided for pin, the system will validate that it matches the pin in the url parameter.

==== Update a crispr plan

===== Example Request

Curl:
include::{snippets}/plans/putCrisprPlan/http-request.adoc[]

===== Example Response

include::{snippets}/plans/putCrisprPlan/http-response.adoc[]

==== Update a phenotyping plan

===== Example Request

Curl:

include::{snippets}/plans/putPhenotypingPlan/http-request.adoc[]

===== Example Response

include::{snippets}/plans/putPhenotypingPlan/http-response.adoc[]


== Outcomes
anchor:outcomes[]
This section describes the REST endpoints for outcomes in the system.

[TODO:DEFINITION]

An outcome can be either a colony or a specimen.

=== Fields
These are the fields you are going to see in the body of a request in a GET or in the payload for POST or PUT
operations.

==== Colony
include::{snippets}/outcomes/colonyOutcome/response-fields.adoc[]

==== Specimen
include::{snippets}/outcomes/specimenOutcome/response-fields.adoc[]


=== GET
==== Get a specific outcome (Colony)

This endpoint a specific outcome belonging to a plan. In this example the outcome is a colony.

===== Example Request

Curl:
include::{snippets}/outcomes/colonyOutcome/curl-request.adoc[]

===== Example Response

include::{snippets}/outcomes/colonyOutcome/http-response.adoc[]


==== Get a specific outcome (Specimen)

This endpoint a specific outcome belonging to a plan. In this example the outcome is a colony.

===== Example Request

Curl:
include::{snippets}/outcomes/specimenOutcome/curl-request.adoc[]

===== Example Response

include::{snippets}/outcomes/specimenOutcome/http-response.adoc[]


==== Get all outcomes in a plan
This endpoint shows all the outcomes associated to a plan.

===== Example Request

Curl:
include::{snippets}/outcomes/allOutcomes/curl-request.adoc[]

===== Example Response

include::{snippets}/outcomes/allOutcomes/http-response.adoc[]

==== Get the history of changes for an outcome

You can use this endpoint to see all the changes that have been made on an outcome.

===== Example Request

Curl:
include::{snippets}/outcomes/colonyOutcome/history/curl-request.adoc[]

===== Example Response

include::{snippets}/outcomes/colonyOutcome/history/http-response.adoc[]


=== POST

==== Create an outcome (colony)

===== Example Request

Curl:
include::{snippets}/outcomes/postColonyOutcome/http-request.adoc[]

===== Example Response

include::{snippets}/outcomes/postColonyOutcome/http-response.adoc[]

=== PUT

==== Update an outcome (colony)


===== Example Request

Curl:
include::{snippets}/outcomes/putColonyOutcome/http-request.adoc[]

===== Example Response

include::{snippets}/outcomes/putColonyOutcome/http-response.adoc[]


== Mutations
anchor:mutations[]
This section describes the REST endpoints for mutations in the system.

=== Fields
These are the fields you are going to see in the body of a request in a GET or in the payload for POST or PUT
operations.
include::{snippets}/mutations/response-fields.adoc[]

=== GET
==== Get a specific mutation

This endpoint fetches a specific mutation associated with an outcome.

===== Example Request

Curl:
include::{snippets}/mutations/curl-request.adoc[]

===== Example Response

include::{snippets}/mutations/http-response.adoc[]

== Phenotyping Stages
anchor:phenotypingStages[]
This section describes the REST endpoints for phenotyping stages in the system.

[TODO:DEFINITION]
DFSDF

=== Fields
These are the fields you are going to see in the body of a request in a GET or in the payload for POST or PUT
operations.

include::{snippets}/phenotypingStages/getPhenotypingStage/response-fields.adoc[]


=== GET
==== Get a specific phenotyping stage

This endpoint fetches a specific phenotyping stage belonging to a plan.

===== Example Request

Curl:
include::{snippets}/phenotypingStages/getPhenotypingStage/curl-request.adoc[]

===== Example Response

include::{snippets}/phenotypingStages/getPhenotypingStage/http-response.adoc[]


==== Get all phenotyping stages in a plan
This endpoint shows all the phenotyping stages associated to a plan.

===== Example Request

Curl:
include::{snippets}/phenotypingStages/allPhenotypingStages/curl-request.adoc[]

===== Example Response

include::{snippets}/phenotypingStages/allPhenotypingStages/http-response.adoc[]

==== Get the history of changes for a phenotyping stage

You can use this endpoint to see all the changes that have been made on a phenotyping stage.

===== Example Request

Curl:
include::{snippets}/phenotypingStages/history/curl-request.adoc[]

===== Example Response

include::{snippets}/phenotypingStages/history/http-response.adoc[]


=== POST

==== Create a phenotyping stage

===== Example Request

Curl:
include::{snippets}/phenotypingStages/postPhenotypingStage/http-request.adoc[]

===== Example Response
include::{snippets}/phenotypingStages/postPhenotypingStage/http-response.adoc[]


=== PUT

==== Update a phenotyping stage

===== Example Request

Curl:
include::{snippets}/phenotypingStages/putPhenotypingStage/http-request.adoc[]

===== Example Response
include::{snippets}/phenotypingStages/putPhenotypingStage/http-response.adoc[]


== State Machine interaction

==== Structure

Several entities in GenTaR rely on a state machine to control the logic to change from one status
to another. The state machines for these entities are described in the following document.

link:state_machine_transitions.pdf[state_machine_transitions.pdf]

When you do a GET to one of those entities, you'll get as part of the response a *statusTransition*
section, which contains information about the current status and what actions can be executed in order
to change that status.

```json
"statusTransition" : {
    "currentStatus" : "Founder Obtained",
    "transitions" : [ {
    "action" : "abortWhenFounderObtained",
    "description" : "Abort the plan after a founder obtained",
    "triggeredByUser" : true,
    "available" : true,
    "note" : null,
    "nextStatus" : "AttemptAborted"
    } ],
    "actionToExecute" : null
```


|===
|Path|Type|Description

|`+statusTransition+`
|`+Object+`
|Information about the current state in the state machine for the plan.

|`+statusTransition.currentStatus+`
|`+String+`
|Current status in the plan

|`+statusTransition.transitions[]+`
|`+Array+`
|Transitions in the state machine given the current state.

|`+statusTransition.transitions[].action+`
|`+String+`
|Action or transition's name.

|`+statusTransition.transitions[].description+`
|`+String+`
|Transition's description.

|`+statusTransition.transitions[].triggeredByUser+`
|`+Boolean+`
|Indicates whether the transition is executed by the user or by the system.

|`+statusTransition.transitions[].available+`
|`+Boolean+`
|Indicates if the transition can be executed at the moment.

|`+statusTransition.transitions[].note+`
|`+Null+`
|Additional explanation about the availability to execute the transition.

|`+statusTransition.transitions[].nextStatus+`
|`+String+`
|Next status that the plan will have if the transition is executed.

|`+statusTransition.actionToExecute+`
|`+Null+`
|Name of the transition (action) to execute.


|===


==== How to execute a change in the state machine?
To execute a transition in the plan, you need to choose an action that is _triggeredByUser = true_
and _available = true_ and send a PUT request (as a normal plan update ) passing the name of the action
as the value _actionToExecute_ in the statusTransition section of the payload.


===== Example Request

Let's suppose you want to abort a crispr plan that has the status _Founder Obtained_. If we do a _GET_
to the plan we want to abort, you will see the _statusTransition_ section with a single available
transition executable by the user: *abortWhenFounderObtained*.

Use the name of the action (abortWhenFounderObtained) as the value in the field *actionToExecute*.

You can use the whole GET response as the payload for the new operation. You can also decide to send
only the _statusTransition_ information in the payload. The following is an example of the request
in case you decide to left out the attempt information:

Curl:
include::{snippets}/plans/putCrisprPlanStateMachine/http-request.adoc[]


===== Example Response

The response will indicate what changed in the system, as long as a link to the resource in
case you need to retrieve the new object.

include::{snippets}/plans/putCrisprPlanStateMachine/http-response.adoc[]







